<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Getting Started: Serving Web Content</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
</head>
<body>
<p th:text="'Hello, ' + ${name} + '!'" />
<!--<img id="conquestMap" src="/greeting/img/42"/>-->
<canvas id="myCanvas" width="1000" height="800"></canvas>
<div>
    <select id="lineType" name="lineType">
        <option th:each="line : ${lineTypes}"
                th:value="${line.lineName}"
                th:utext="${line.lineName}"/>
    </select>
</div>


<script th:inline="javascript">
    /*<![CDATA[*/
    function writeMessage(canvas, message, imageObj, points) {
        var map =/*[[${map}]]*/ 'bla';
        var context = canvas.getContext('2d');
        context.clearRect(0, 0, 1000, 1000);
        context.drawImage(imageObj, 0, 100);
        context.font = '18pt Calibri';
        context.fillStyle = 'black';
        context.fillText(message, 10, 25);
        for(var i = 0; i < map.regions.length; i++) {
            context.beginPath();
            context.moveTo(map.regions[i].points[0].x,map.regions[i].points[0].y);
            for(var j = 1; j < map.regions[i].points.length; j++) {
                context.lineTo(map.regions[i].points[j].x,map.regions[i].points[j].y);
            }
            context.closePath();
            context.stroke();
        }

        context.moveTo(points[0].x, points[0].y);
        for(var i = 1; i < points.length; i++) {
            context.lineTo(points[i].x, points[i].y);
        }
        context.stroke();
    }
    function getMousePos(canvas, evt) {
        var rect = canvas.getBoundingClientRect();
        return {
            x: evt.clientX - rect.left,
            y: evt.clientY - rect.top
        };
    }
   // var img = document.getElementById('conquestMap');
    var canvas = document.getElementById('myCanvas');
    var line = document.getElementById('lineType');
    var context = canvas.getContext('2d');

    var imageObj = new Image();

    imageObj.onload = function() {
        context.drawImage(imageObj, 0, 100);
    };
    imageObj.src = '/greeting/img/42';
    var points = [];

    canvas.addEventListener('click', function(evt) {
        var mousePos = getMousePos(canvas, evt);
        var message = 'Mouse position: ' + mousePos.x + ',' + mousePos.y+ ' line '+line.value;
        var oReq = new XMLHttpRequest();
        oReq.open("GET", "/greeting/bla/"+mousePos.x, true);
        oReq.setRequestHeader('x-requested-with', 'XMLHttpRequest');
        points.push({x:mousePos.x,y:mousePos.y})
        // oReq.onload = function () {
        //     // Запрос завершен. Здесь можно обрабатывать результат.
        // };
       // oReq.send();

        // jQuery().ajax({
        //     url : '/greeting/bla/'+mousePos.x,
        //     method : 'GET'
        // });


        writeMessage(canvas, message, imageObj,points);
    }, false);

    /*]]>*/
</script>

</body>
</html>